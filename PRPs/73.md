# PRP-73: Build Admin Testing Interface for Role-Based Security

## Goal
Build a comprehensive admin testing interface in the new `nextjs-ui` folder to validate role-based security and all user actions. This interface will serve as both a testing tool and future backoffice system, using Next.js 15.4.3 with modern React patterns, TypeScript, and comprehensive testing infrastructure.

## Why
- **Security Validation**: Need to thoroughly test role-based access control across 5 user roles (Admin, Professional, Staff, Client, Guest)
- **Development Efficiency**: Provides a UI for testing all API endpoints without relying on curl commands
- **Future Backoffice**: Foundation for the production admin panel
- **Quality Assurance**: Ensures 100% test coverage for frontend components and API integration

## What
A fully functional Next.js 15.4.3 admin interface with:
- JWT authentication with organization header support
- Complete user CRUD operations with role management
- Role-based access control UI components
- API client with interceptors for multi-tenancy
- Comprehensive test coverage using Jest, React Testing Library, and MSW
- Type-safe state management with Zustand and TanStack Query

### Success Criteria
- [ ] Next.js 15.4.3 app running on port 8080 via skaffold dev
- [ ] JWT authentication integrated with Rails API (port 4000)
- [ ] User management CRUD with all 5 roles functional
- [ ] 100% unit test coverage for components and hooks
- [ ] MSW mocks for all API endpoints
- [ ] Role-based UI elements show/hide correctly
- [ ] Multi-tenant organization headers working
- [ ] Error handling for 401/403/422 responses

## All Needed Context

### Documentation & References
```yaml
# MUST READ - Include these in your context window
- url: https://nextjs.org/docs/app
  why: Next.js 15 App Router patterns, Server Components, TypeScript setup
  
- url: https://tanstack.com/query/latest/docs/framework/react/overview
  why: Server state management, optimistic updates, caching strategies
  
- url: https://docs.pmnd.rs/zustand/getting-started/introduction
  why: Client state management with TypeScript, persist middleware
  
- url: https://mswjs.io/docs/integrations/react
  why: API mocking for tests, request handlers, response resolvers
  
- url: https://testing-library.com/docs/react-testing-library/intro/
  why: Component testing patterns, best practices for user-centric tests

- file: /issues/SCRUM-73/examples/api-client-interceptors.ts
  why: Axios configuration pattern with JWT and multi-tenant headers
  
- file: /issues/SCRUM-73/examples/zustand-auth-store.ts
  why: Type-safe Zustand store with persist and role-based getters
  
- file: /issues/SCRUM-73/examples/react-query-hooks.tsx
  why: TanStack Query hooks for CRUD operations with optimistic updates
  
- file: /issues/SCRUM-73/examples/msw-mock-handlers.ts
  why: Complete MSW setup with all API endpoints mocked
  
- file: /issues/SCRUM-73/examples/role-based-access-control.tsx
  why: RBAC patterns for protected routes and conditional rendering

- file: /PRPs/71-results.md
  why: JWT authentication implementation details, payload structure
  
- file: /PRPs/72-results.md
  why: Backend API endpoints status, all tests passing
```

### Current Codebase Tree
```bash
nextjs-ui/
├── Dockerfile
├── README.md
├── eslint.config.mjs
├── next-env.d.ts
├── next.config.ts
├── package.json          # Basic Next.js 15.4.3 setup
├── postcss.config.mjs
├── public/
├── src/
│   └── app/
│       ├── favicon.ico
│       ├── globals.css
│       ├── layout.tsx
│       └── page.tsx
└── tsconfig.json
```

### Desired Codebase Tree
```bash
nextjs-ui/
├── .env.local                        # Environment variables
├── jest.config.js                    # Jest configuration
├── jest.setup.js                     # Jest setup with MSW
├── src/
│   ├── app/
│   │   ├── admin/                    # Admin routes (protected)
│   │   │   ├── layout.tsx            # Admin layout with navigation
│   │   │   ├── page.tsx              # Admin dashboard
│   │   │   └── users/                # User management
│   │   │       ├── [id]/
│   │   │       │   └── page.tsx      # User detail/edit
│   │   │       ├── new/
│   │   │       │   └── page.tsx      # Create user
│   │   │       └── page.tsx          # Users list
│   │   ├── login/
│   │   │   └── page.tsx              # Login page
│   │   └── layout.tsx                # Root layout with providers
│   ├── components/
│   │   ├── auth/
│   │   │   ├── LoginForm.tsx         # Login form component
│   │   │   └── ProtectedRoute.tsx    # Route protection HOC
│   │   ├── common/
│   │   │   ├── ErrorBoundary.tsx     # Error boundary wrapper
│   │   │   └── LoadingSpinner.tsx    # Loading states
│   │   ├── admin/
│   │   │   ├── AdminNav.tsx          # Admin navigation
│   │   │   └── RoleBasedMenu.tsx     # Role-based menu items
│   │   └── users/
│   │       ├── UserTable.tsx          # Users table with actions
│   │       ├── UserForm.tsx           # Create/edit user form
│   │       └── PasswordChangeForm.tsx # Change password form
│   ├── hooks/
│   │   ├── useAuth.ts                # Auth hooks
│   │   ├── useUsers.ts               # User CRUD hooks
│   │   └── usePermissions.ts         # Permission checking hooks
│   ├── lib/
│   │   ├── api/
│   │   │   ├── client.ts             # Axios instance with interceptors
│   │   │   └── endpoints.ts          # API endpoint functions
│   │   └── utils/
│   │       └── errorHandling.ts      # Error handling utilities
│   ├── stores/
│   │   └── authStore.ts              # Zustand auth store
│   ├── providers/
│   │   ├── QueryProvider.tsx         # TanStack Query provider
│   │   └── RootProvider.tsx          # Combined providers
│   ├── types/
│   │   ├── user.ts                   # User type definitions
│   │   └── api.ts                    # API response types
│   └── __tests__/
│       ├── components/               # Component tests
│       ├── hooks/                    # Hook tests
│       └── mocks/
│           ├── handlers.ts           # MSW mock handlers
│           └── server.ts             # MSW server setup
```

### Known Gotchas & Library Quirks
```typescript
// CRITICAL: Next.js 15 with App Router requires 'use client' for interactive components
// CRITICAL: React 19 requires proper key handling in lists
// CRITICAL: Tailwind CSS v4 uses new @tailwindcss/postcss plugin
// CRITICAL: JWT tokens from Rails API use 'user_id' not 'sub' in payload
// CRITICAL: Organization subdomain must be included in X-Organization-Subdomain header
// CRITICAL: MSW v2 requires different setup than v1 - use setupWorker for browser
// CRITICAL: Zustand persist middleware needs SSR-safe initialization
// CRITICAL: TanStack Query v5 has different import paths than v4
```

## Implementation Blueprint

### Nextjs dependancy installation
Make sure you install all dependancies by running the command yarn add inside the nextjs-ui project folder. Skaffold dev will be in charge of updating the image inside the cluster

### Data Models and Structure
```typescript
// types/user.ts
export interface User {
  id: number;
  email: string;
  first_name: string;
  last_name: string;
  full_name: string;
  phone?: string;
  role: 'admin' | 'professional' | 'staff' | 'guardian';
  organization?: Organization;
  created_at: string;
  updated_at: string;
}

// types/api.ts
export interface ApiResponse<T> {
  data: T;
  meta?: {
    total: number;
    page: number;
    per_page: number;
  };
}

export interface ApiError {
  error: string;
  errors?: Record<string, string[]>;
  status: number;
}
```

### List of Tasks

```yaml
Task 1: Project Setup and Dependencies
MODIFY nextjs-ui/package.json:
  - ADD dependencies: axios, zustand, @tanstack/react-query, @tanstack/react-query-devtools
  - ADD devDependencies: jest, @testing-library/react, @testing-library/jest-dom, msw, @types/jest
  - ADD scripts: "test": "jest", "test:watch": "jest --watch", "test:coverage": "jest --coverage"

CREATE nextjs-ui/.env.local:
  - ADD NEXT_PUBLIC_API_URL=http://localhost:4000/api/v1

CREATE nextjs-ui/jest.config.js:
  - COPY standard Next.js jest config with jsdom environment
  - CONFIGURE module name mapper for @ alias

CREATE nextjs-ui/jest.setup.js:
  - IMPORT @testing-library/jest-dom
  - SETUP MSW server for tests

Task 2: API Client Setup
CREATE src/lib/api/client.ts:
  - COPY pattern from examples/api-client-interceptors.ts
  - UPDATE API_BASE_URL to use process.env.NEXT_PUBLIC_API_URL
  - ENSURE JWT and organization headers in request interceptor
  - IMPLEMENT 401 redirect to /login

CREATE src/types/user.ts:
  - DEFINE User and Organization interfaces
  - EXPORT type guards for role checking

CREATE src/types/api.ts:
  - DEFINE ApiResponse<T> and ApiError types
  - EXPORT error type guards

Task 3: Zustand Store Implementation
CREATE src/stores/authStore.ts:
  - COPY pattern from examples/zustand-auth-store.ts
  - IMPLEMENT SSR-safe initialization
  - ADD persist middleware with localStorage
  - ENSURE role-based computed getters

Task 4: TanStack Query Setup
CREATE src/providers/QueryProvider.tsx:
  - SETUP QueryClient with default options
  - CONFIGURE staleTime and cacheTime
  - WRAP with QueryClientProvider

CREATE src/providers/RootProvider.tsx:
  - COMBINE QueryProvider with other providers
  - ENSURE proper provider nesting order

Task 5: Authentication Components
CREATE src/components/auth/LoginForm.tsx:
  - IMPLEMENT email/password form with react-hook-form
  - USE mutation hook for login API call
  - HANDLE validation errors from API
  - REDIRECT to /admin on success

CREATE src/components/auth/ProtectedRoute.tsx:
  - CHECK isAuthenticated from authStore
  - REDIRECT to /login if not authenticated
  - OPTIONAL: Check specific roles

Task 6: User Management Hooks
CREATE src/hooks/useUsers.ts:
  - COPY pattern from examples/react-query-hooks.tsx
  - IMPLEMENT useUsers, useUser, useCreateUser, useUpdateUser, useDeleteUser
  - ENSURE proper cache invalidation

CREATE src/hooks/useAuth.ts:
  - IMPLEMENT useLogin, useLogout hooks
  - INTEGRATE with authStore

Task 7: Admin Layout and Navigation
CREATE src/app/admin/layout.tsx:
  - WRAP with ProtectedRoute
  - INCLUDE AdminNav component
  - ADD loading and error boundaries

CREATE src/components/admin/AdminNav.tsx:
  - IMPLEMENT navigation menu
  - USE role-based menu items
  - HIGHLIGHT active route

Task 8: User Management Pages
CREATE src/app/admin/users/page.tsx:
  - USE useUsers hook for data fetching
  - RENDER UserTable component
  - IMPLEMENT pagination

CREATE src/components/users/UserTable.tsx:
  - DISPLAY users in table format
  - ADD edit/delete actions per row
  - IMPLEMENT role-based action visibility

CREATE src/components/users/UserForm.tsx:
  - IMPLEMENT form for create/edit
  - USE react-hook-form for validation
  - HANDLE API errors gracefully

Task 9: MSW Mock Setup
CREATE src/__tests__/mocks/handlers.ts:
  - COPY pattern from examples/msw-mock-handlers.ts
  - MOCK all user API endpoints
  - INCLUDE error scenarios

CREATE src/__tests__/mocks/server.ts:
  - SETUP MSW server for Node
  - CONFIGURE for jest environment

Task 10: Component Tests
CREATE src/__tests__/components/auth/LoginForm.test.tsx:
  - TEST successful login flow
  - TEST validation errors
  - TEST API error handling

CREATE src/__tests__/components/users/UserTable.test.tsx:
  - TEST data rendering
  - TEST pagination
  - TEST role-based actions

CREATE src/__tests__/hooks/useUsers.test.tsx:
  - TEST CRUD operations
  - TEST optimistic updates
  - TEST error scenarios

Task 11: Integration and Final Validation
UPDATE src/app/layout.tsx:
  - WRAP with RootProvider
  - ENSURE proper metadata

CREATE src/app/login/page.tsx:
  - RENDER LoginForm component
  - REDIRECT if already authenticated

RUN all tests and ensure 100% coverage
FIX any failing tests
VALIDATE with skaffold dev
```

### Per Task Pseudocode

```typescript
// Task 2: API Client
// src/lib/api/client.ts
const apiClient = axios.create({
  baseURL: process.env.NEXT_PUBLIC_API_URL,
  timeout: 30000,
});

apiClient.interceptors.request.use((config) => {
  // PATTERN: Get token from localStorage (set by authStore)
  const token = localStorage.getItem('auth_token');
  if (token) {
    config.headers.Authorization = `Bearer ${token}`;
  }
  
  // PATTERN: Add organization header for multi-tenancy
  const subdomain = localStorage.getItem('organization_subdomain');
  if (subdomain) {
    config.headers['X-Organization-Subdomain'] = subdomain;
  }
  
  return config;
});

// Task 6: User Hooks
// src/hooks/useUsers.ts
export const useUsers = (params?: GetUsersParams) => {
  return useQuery({
    queryKey: ['users', params],
    queryFn: () => userApi.getUsers(params),
    staleTime: 5 * 60 * 1000, // 5 minutes
  });
};

export const useCreateUser = () => {
  const queryClient = useQueryClient();
  
  return useMutation({
    mutationFn: userApi.createUser,
    onSuccess: () => {
      // CRITICAL: Invalidate users list
      queryClient.invalidateQueries({ queryKey: ['users'] });
    },
    onError: (error) => {
      // PATTERN: Use toast or notification system
      console.error('Failed to create user:', error);
    },
  });
};
```

### Integration Points
```yaml
ENVIRONMENT:
  - file: .env.local
  - variable: NEXT_PUBLIC_API_URL=http://localhost:4000/api/v1
  
ROUTING:
  - protect: /admin/* routes with ProtectedRoute
  - public: /login route
  
STATE:
  - persist: authStore token and user in localStorage
  - clear: on logout or 401 response
  
API:
  - base: http://localhost:4000/api/v1
  - endpoints: /login, /logout, /users, /users/:id
  - headers: Authorization: Bearer <token>, X-Organization-Subdomain: <subdomain>
```

## Validation Loop

### Level 1: Syntax & Style
```bash
# From nextjs-ui directory
yarn lint                    # ESLint checks
yarn typecheck              # TypeScript compilation
# Expected: No errors. Fix any issues before proceeding.
```

### Level 2: Unit Tests
```bash
# Run all tests
yarn test

# Run with coverage
yarn test:coverage

# Watch mode for TDD
yarn test:watch

# Expected: 100% coverage, all tests passing
```

### Level 3: Integration Test
```bash
# Start the full stack
cd /Volumes/HOMEX/Carlos1/coding/2025/rayces-v3
skaffold dev

# Wait for services to be ready
# Frontend: http://localhost:8080
# Backend: http://localhost:4000

# Test login flow
# 1. Navigate to http://localhost:8080/login
# 2. Login with test credentials
# 3. Verify redirect to /admin
# 4. Test user CRUD operations
```

### Level 4: Running Backend Tests
```bash
# Get Rails pod and run tests
kubectl exec -n raycesv3 $(kubectl get pods -n raycesv3 | grep rails-rayces | grep Running | awk '{print $1}') -- bundle exec rspec

# Run specific test files if needed
kubectl exec -n raycesv3 $(kubectl get pods -n raycesv3 | grep rails-rayces | grep Running | awk '{print $1}') -- bundle exec rspec spec/requests/api/v1/users_spec.rb

# Check Rails logs for errors
kubectl logs -n raycesv3 $(kubectl get pods -n raycesv3 | grep rails-rayces | grep Running | awk '{print $1}') -f
```

## Final Validation Checklist
- [ ] All dependencies installed: `yarn install`
- [ ] Environment variables configured in `.env.local`
- [ ] All TypeScript types defined with no `any` types
- [ ] 100% test coverage: `yarn test:coverage`
- [ ] No linting errors: `yarn lint`
- [ ] No type errors: `yarn typecheck`
- [ ] Login flow works end-to-end
- [ ] User CRUD operations functional
- [ ] Role-based UI elements working
- [ ] Multi-tenant headers sent correctly
- [ ] Error handling for all API scenarios
- [ ] MSW mocks cover all endpoints

## Anti-Patterns to Avoid
- ❌ Don't use 'use client' on every component - only interactive ones
- ❌ Don't store sensitive data in localStorage beyond tokens
- ❌ Don't skip error boundaries - wrap all routes
- ❌ Don't hardcode API URLs - use environment variables
- ❌ Don't ignore TypeScript errors - fix them properly
- ❌ Don't mock to make tests pass - fix the actual code
- ❌ Don't use synchronous localStorage access in SSR
- ❌ Don't forget to handle loading and error states

## Error Recovery Procedures
1. **Build Errors**: Check `next.config.ts` and TypeScript config
2. **Test Failures**: Run in watch mode to debug: `yarn test:watch`
3. **API Connection Issues**: Verify backend is running on port 4000
4. **Auth Issues**: Check JWT payload structure matches backend
5. **State Persistence Issues**: Ensure SSR-safe Zustand initialization

## Learning Golden Nuggets

### Database Seeding Insights
1. **Seed File Organization**: The `db/seeds.rb` file was mostly commented out (lines 498-650), which prevented full data creation. Always check for commented sections in seed files.

2. **Foreign Key Relationships**: The appointments table uses `professional_id` that references the `users` table, NOT the `professionals` table. When creating appointments, use User objects:
   ```ruby
   # WRONG - This causes ActiveRecord::AssociationTypeMismatch
   Appointment.create!(professional: prof_cavanagh, ...)  # prof_cavanagh is a Professional object
   
   # CORRECT
   Appointment.create!(professional: maria_cavanagh, ...)  # maria_cavanagh is a User object
   ```

3. **Validation Bypass for Seeds**: When creating test data, validations can be too strict. Use `save!(validate: false)` to bypass validations:
   ```ruby
   appointment = Appointment.new(...)
   appointment.save!(validate: false)
   ```

4. **Running Seeds in Kubernetes**: Always run migrations before seeds to avoid connection issues:
   ```bash
   # Run migrations first
   kubectl exec -n raycesv3 $(kubectl get pods -n raycesv3 | grep rails-rayces | grep Running | awk '{print $1}') -- bundle exec rails db:migrate
   
   # Then run seeds
   kubectl exec -n raycesv3 $(kubectl get pods -n raycesv3 | grep rails-rayces | grep Running | awk '{print $1}') -- bundle exec rails db:seed
   
   # Or reset everything (WARNING: deletes all data)
   kubectl exec -n raycesv3 $(kubectl get pods -n raycesv3 | grep rails-rayces | grep Running | awk '{print $1}') -- bundle exec rails db:drop db:create db:migrate db:seed
   ```

5. **Multi-Tenant Seeding**: The seeds create two organizations (Rayces and Demo) with proper tenant isolation using `ActsAsTenant.with_tenant(org)` blocks.

6. **Comprehensive Test Data**: The fixed seeds now create:
   - 2 Organizations
   - 15 Users with various roles
   - 8 Professional profiles (based on real Rayces team)
   - 4 Students with parent relationships
   - 4 Appointments in different states

7. **Default Credentials**: All seeded users use password `password123` for easy testing.

---

**Confidence Score: 9/10**

This PRP provides comprehensive context for implementing the admin testing interface. The high confidence comes from:
- Existing Next.js setup already in place
- Clear examples provided in the issues folder
- Backend API fully implemented and tested
- Well-documented patterns to follow
- Comprehensive testing strategy included

The 1-point deduction is for potential integration challenges between the new nextjs-ui and the Rails API that may require minor adjustments during implementation.